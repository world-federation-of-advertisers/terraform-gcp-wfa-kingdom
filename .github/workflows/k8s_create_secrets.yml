name: Generate Certificates and Keys

on:
  push:
    branches: [ "terraform-duchy" ]

jobs:
  generate-certs-secrets:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout
        uses: actions/checkout@v2

        env:
          KUBECONFIG: ${{ secrets.KUBECONFIG }}

      - name: Generate certificates and keys
        run: |
          openssl genrsa -out ca.key 2048
          openssl req -new -key ca.key -subj "/CN=kubernetes-ca" -out ca.csr
          openssl x509 -req -in ca.csr -signkey ca.key -out ca.crt

          openssl genrsa -out server.key 2048
          openssl req -new -key server.key -subj "/CN=kubernetes" -out server.csr
          openssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 365

          openssl genrsa -out client.key 2048
          openssl req -new -key client.key -subj "/CN=kubernetes-client" -out client.csr
          openssl x509 -req -in client.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out client.crt -days 365

#      - name: Create secret
 ###       --from-file=ca.crt=ca.crt \
    #      --from-file=server.crt=server.crt \
     #     --from-file=server.key=server.key \
      #    --from-file=client.crt=client.crt \
       #   --from-file=client.key=client.key \
        #  --namespace=default
